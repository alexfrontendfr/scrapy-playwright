<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Scraper - Terminal Matrix UI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      #matrix {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
    </style>
  </head>
  <body class="bg-black text-green-500 font-mono">
    <canvas id="matrix"></canvas>
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-4xl mb-5 text-center">
        Web Scraper - Terminal Matrix UI
      </h1>
      <form id="searchForm" class="mb-8">
        <div class="mb-4">
          <label for="query" class="block mb-2">Enter Search Term:</label>
          <input
            type="text"
            id="query"
            name="query"
            required
            class="w-full p-2 bg-gray-800 text-green-500 border border-green-500"
          />
        </div>
        <div class="mb-4">
          <label for="engine" class="block mb-2">Select Search Engine:</label>
          <select
            id="engine"
            name="engine"
            required
            class="w-full p-2 bg-gray-800 text-green-500 border border-green-500"
          >
            <option value="bing">Bing</option>
            <option value="duckduckgo">DuckDuckGo</option>
            <option value="google">Google</option>
            <option value="onion">Onion</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="limit" class="block mb-2">Result Limit:</label>
          <input
            type="number"
            id="limit"
            name="limit"
            value="10"
            min="1"
            max="100"
            class="w-full p-2 bg-gray-800 text-green-500 border border-green-500"
          />
        </div>
        <div class="mb-4">
          <label for="use_tor" class="inline-flex items-center">
            <input
              type="checkbox"
              id="use_tor"
              name="use_tor"
              class="form-checkbox h-5 w-5 text-green-500"
            />
            <span class="ml-2">Use Tor (for anonymous scraping)</span>
          </label>
        </div>
        <button
          type="submit"
          class="w-full p-2 bg-green-500 text-black hover:bg-green-400"
        >
          Start Search
        </button>
      </form>
      <div id="loadingSpinner" class="mt-5 text-center" style="display: none">
        Searching... Please wait.
      </div>
      <div
        id="progressBar"
        class="w-full bg-gray-800 mt-5"
        style="height: 25px; display: none"
      >
        <div
          id="progressBarFill"
          class="bg-green-500 h-full text-black text-center"
          style="width: 0%"
        >
          0%
        </div>
      </div>
      <div id="results" class="mt-8"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // Matrix background effect
      const canvas = document.getElementById("matrix");
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const katakana =
        "アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン";
      const latin = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const nums = "0123456789";
      const alphabet = katakana + latin + nums;
      const fontSize = 16;
      const columns = canvas.width / fontSize;
      const rainDrops = [];
      for (let x = 0; x < columns; x++) {
        rainDrops[x] = 1;
      }
      const draw = () => {
        ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#0F0";
        ctx.font = fontSize + "px monospace";
        for (let i = 0; i < rainDrops.length; i++) {
          const text = alphabet.charAt(
            Math.floor(Math.random() * alphabet.length)
          );
          ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);
          if (
            rainDrops[i] * fontSize > canvas.height &&
            Math.random() > 0.975
          ) {
            rainDrops[i] = 0;
          }
          rainDrops[i]++;
        }
      };
      setInterval(draw, 30);

      // Form submission and results handling
      document
        .getElementById("searchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);

          document.getElementById("loadingSpinner").style.display = "block";
          document.getElementById("progressBar").style.display = "block";
          document.getElementById("results").innerHTML = "";

          try {
            const response = await axios.post("/search", formData, {
              onUploadProgress: (progressEvent) => {
                const percentCompleted = Math.round(
                  (progressEvent.loaded * 100) / progressEvent.total
                );
                document.getElementById("progressBarFill").style.width =
                  percentCompleted + "%";
                document.getElementById("progressBarFill").innerText =
                  percentCompleted + "%";
              },
            });

            const results = await fetchResults();
            displayResults(results);
          } catch (error) {
            console.error("Error:", error);
            document.getElementById("results").innerHTML =
              '<p class="text-red-500">An error occurred while processing your request.</p>';
          } finally {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("progressBar").style.display = "none";
          }
        });

      async function fetchResults() {
        const response = await axios.get("/results");
        return response.data;
      }

      function displayResults(results) {
        const resultsContainer = document.getElementById("results");
        if (results.length === 0) {
          resultsContainer.innerHTML = "<p>No results found.</p>";
          return;
        }

        let html = '<h2 class="text-2xl mb-4">Search Results:</h2><ul>';
        results.forEach((result) => {
          html += `<li class="mb-2"><a href="${result.url}" target="_blank" class="text-green-500 hover:underline">${result.url}</a></li>`;
        });
        html += "</ul>";
        resultsContainer.innerHTML = html;
      }
    </script>
  </body>
</html>
